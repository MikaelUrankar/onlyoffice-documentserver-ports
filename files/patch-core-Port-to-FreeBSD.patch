From 55974afab09986aa9ff6a7a44145ce6e3765fc48 Mon Sep 17 00:00:00 2001
From: MikaelUrankar <mikael.urankar@gmail.com>
Date: Sat, 27 Jun 2020 17:51:46 +0200
Subject: [PATCH] Port to FreeBSD

---
 .../DocDocxConverter/StringTable.h            |  4 ++--
 ASCOfficeRtfFile/RtfFormatLib/source/Utils.h  |  2 +-
 .../source/XlsFormat/Auxiliary/HelpFunc.cpp   |  4 ++--
 .../source/XlsFormat/Crypt/rtl/cipher.h       |  2 +-
 .../source/XlsFormat/Crypt/rtl/digest.h       |  2 +-
 .../Logic/Biff_structures/BitMarkedStructs.h  |  2 +-
 Common/3dParty/cryptopp/project/cryptopp.pro  |  1 +
 Common/3dParty/icu/icu.pri                    |  7 ++++++
 Common/3dParty/openssl/openssl.pri            | 10 ++++++++
 Common/3dParty/v8/v8.pri                      |  5 ++++
 Common/3dParty/v8/v8_xp/v8.pri                |  5 ++++
 Common/DocxFormat/Source/Base/Types_32.h      |  2 +-
 Common/DocxFormat/Source/DocxFormat/Docx.cpp  |  2 +-
 .../DocxFormat/Source/XlsxFormat/Common.cpp   |  4 ++++
 Common/base.pri                               |  8 +++++++
 Common/kernel.pro                             |  6 +++++
 DesktopEditor/AllFontsGen/AllFontsGen.pro     |  6 +++++
 .../Qt_build/graphics/project/graphics.pri    |  6 +++++
 .../graphics/project/graphics_fonts.pri       |  5 ++++
 DesktopEditor/agg-2.4/include/agg_math.h      |  2 +-
 .../agg-2.4/include/agg_span_gradient.h       |  2 +-
 DesktopEditor/allthemesgen/allthemesgen.pro   |  6 +++++
 DesktopEditor/common/Directory.cpp            | 12 +++++-----
 DesktopEditor/common/File.cpp                 | 23 +++++++++++++++++--
 DesktopEditor/common/Path.cpp                 |  6 ++---
 DesktopEditor/common/Types.h                  |  2 +-
 DesktopEditor/cximage/CxImage/ximage.h        |  2 +-
 DesktopEditor/cximage/CxImage/ximainfo.cpp    |  2 +-
 DesktopEditor/cximage/CxImage/ximajas.h       |  2 +-
 DesktopEditor/cximage/CxImage/ximajpg.cpp     |  2 +-
 DesktopEditor/cximage/CxImage/ximajpg.h       |  2 +-
 DesktopEditor/cximage/CxImage/ximapng.h       |  2 +-
 DesktopEditor/cximage/CxImage/ximaraw.cpp     |  2 +-
 DesktopEditor/cximage/raw/libdcr.h            |  2 +-
 DesktopEditor/cximage/tiff/tif_config.h       |  8 +++----
 DesktopEditor/cximage/tiff/tiffconf.h         |  4 ++--
 DesktopEditor/graphics/pro/graphics.pro       |  6 +++++
 DesktopEditor/graphics/pro/raster.pri         |  6 +++++
 .../JBig2/source/LeptonLib/readfile.cpp       |  4 ++--
 DesktopEditor/xmlsec/libxmlsec.pro            | 10 ++++++++
 DesktopEditor/xmlsec/src/ooxmlsignature.pro   |  4 ++++
 .../OpenSSL_gui_test/OpenSSL_gui_test.pro     |  5 ++++
 DjVuFile/DjVuFile.pro                         | 11 +++++++++
 DjVuFile/libdjvu/DjVuDocument.cpp             |  2 +-
 HtmlFile/HtmlFile.cpp                         |  4 ++--
 HtmlFile/HtmlFile.pro                         |  4 ++++
 Makefile                                      | 16 +++++++++++++
 OfficeUtils/OfficeUtils.pri                   |  5 ++++
 PdfWriter/PdfWriter.pro                       |  4 ++++
 UnicodeConverter/UnicodeConverter.pro         |  4 ++++
 .../icubuilds-mac/icu/unicode/platform.h      |  2 +-
 X2tConverter/build/Qt/X2tConverter.pri        |  4 ++++
 X2tConverter/src/ASCConverters.cpp            |  4 ++--
 53 files changed, 213 insertions(+), 46 deletions(-)

diff --git a/ASCOfficeDocFile/DocDocxConverter/StringTable.h b/ASCOfficeDocFile/DocDocxConverter/StringTable.h
index 9ee5fb69f..9eff20e22 100644
--- core/ASCOfficeDocFile/DocDocxConverter/StringTable.h
+++ core/ASCOfficeDocFile/DocDocxConverter/StringTable.h
@@ -77,13 +77,13 @@ namespace DocFileFormat
 		}
 
 		StringTable( VirtualStreamReader *reader, int code_page_ ): 
-                            code_page(code_page_), fExtend(false), cbData(0), cbExtra(0), DataExtra(NULL)
+                            code_page(code_page_), fExtend(false), cbData(0), cbExtra(0), DataExtra(0)
 		{
             parse( reader, (unsigned int)reader->GetPosition(), 0, false );
 		}
 
 		StringTable( POLE::Stream* tableStream, unsigned int fc, unsigned int lcb, int nWordVersion, bool bReadExta = false) :
-												code_page(1250), fExtend(false), cbData(0), cbExtra(0), DataExtra(NULL)
+												code_page(1250), fExtend(false), cbData(0), cbExtra(0), DataExtra(0)
 		{
 			if ( lcb > 0 )
 			{
diff --git a/ASCOfficeRtfFile/RtfFormatLib/source/Utils.h b/ASCOfficeRtfFile/RtfFormatLib/source/Utils.h
index 57d7f88b0..fb21e78d1 100644
--- core/ASCOfficeRtfFile/RtfFormatLib/source/Utils.h
+++ core/ASCOfficeRtfFile/RtfFormatLib/source/Utils.h
@@ -565,7 +565,7 @@ public:
 				sResult.erase(outsize_with_0 - 1);
                 ansi = false;
             }
-#elif defined(__linux__)
+#elif defined(__FreeBSD__) || defined(__linux__)
             std::string sCodepage =  "CP" + std::to_string(nCodepage);
 
             iconv_t ic= iconv_open("WCHAR_T", sCodepage.c_str());
diff --git a/ASCOfficeXlsFile2/source/XlsFormat/Auxiliary/HelpFunc.cpp b/ASCOfficeXlsFile2/source/XlsFormat/Auxiliary/HelpFunc.cpp
index 900bbe775..894fd26b0 100644
--- core/ASCOfficeXlsFile2/source/XlsFormat/Auxiliary/HelpFunc.cpp
+++ core/ASCOfficeXlsFile2/source/XlsFormat/Auxiliary/HelpFunc.cpp
@@ -352,7 +352,7 @@ const std::wstring unescape_ST_Xstring(const std::wstring& wstr)
     while(true)
 	{
         
-#if defined(__linux__) || defined(_MAC) || defined(_IOS)
+#if defined(__FreeBSD__) || defined(__linux__) || defined(_MAC) || defined(_IOS)
 		const auto it_range = boost::make_iterator_range(x_pos_noncopied, wstr_end);
         x_pos_next = boost::algorithm::find_first(it_range, L"_x").begin();
 #else
@@ -469,7 +469,7 @@ std::wstring toStdWStringSystem(std::string ansi_string, const unsigned int code
 			sResult.erase(outsize_with_0 - 1);
             ansi = false;
         }
-#elif defined(__linux__)
+#elif defined(__FreeBSD__) || defined(__linux__)
         std::string sCodepage =  "CP" + std::to_string(code_page);
 
         iconv_t ic= iconv_open("WCHAR_T", sCodepage.c_str());
diff --git a/ASCOfficeXlsFile2/source/XlsFormat/Crypt/rtl/cipher.h b/ASCOfficeXlsFile2/source/XlsFormat/Crypt/rtl/cipher.h
index 61193823b..d1f5fa64e 100644
--- core/ASCOfficeXlsFile2/source/XlsFormat/Crypt/rtl/cipher.h
+++ core/ASCOfficeXlsFile2/source/XlsFormat/Crypt/rtl/cipher.h
@@ -33,7 +33,7 @@
 
 #include <stddef.h>
 
-#ifdef __linux__
+#if defined(__FreeBSD__) || defined(__linux__)
     #include <inttypes.h>
 #endif
 
diff --git a/ASCOfficeXlsFile2/source/XlsFormat/Crypt/rtl/digest.h b/ASCOfficeXlsFile2/source/XlsFormat/Crypt/rtl/digest.h
index 66b2e31ee..542639334 100644
--- core/ASCOfficeXlsFile2/source/XlsFormat/Crypt/rtl/digest.h
+++ core/ASCOfficeXlsFile2/source/XlsFormat/Crypt/rtl/digest.h
@@ -31,7 +31,7 @@
  */
 #pragma once
 
-#ifdef __linux__
+#if defined(__FreeBSD__) || defined(__linux__)
     #include <inttypes.h>
 #endif
 
diff --git a/ASCOfficeXlsFile2/source/XlsFormat/Logic/Biff_structures/BitMarkedStructs.h b/ASCOfficeXlsFile2/source/XlsFormat/Logic/Biff_structures/BitMarkedStructs.h
index a0d679578..c3a89e6b6 100644
--- core/ASCOfficeXlsFile2/source/XlsFormat/Logic/Biff_structures/BitMarkedStructs.h
+++ core/ASCOfficeXlsFile2/source/XlsFormat/Logic/Biff_structures/BitMarkedStructs.h
@@ -31,7 +31,7 @@
  */
 #pragma once
 
-#ifdef __linux__
+#if defined(__FreeBSD__) || defined(__linux__)
     #include <inttypes.h>
 #endif
 
diff --git a/Common/3dParty/cryptopp/project/cryptopp.pro b/Common/3dParty/cryptopp/project/cryptopp.pro
index 00fe14793..509a86de6 100644
--- core/Common/3dParty/cryptopp/project/cryptopp.pro
+++ core/Common/3dParty/cryptopp/project/cryptopp.pro
@@ -11,6 +11,7 @@ PWD_ROOT_DIR = $$PWD
 
 include(../../../../Common/base.pri)
 
+core_freebsd:DEFINES -= NDEBUG
 core_linux:DEFINES -= NDEBUG
 core_mac:DEFINES -= MAC
 core_ios:DEFINES -= MAC
diff --git a/Common/3dParty/icu/icu.pri b/Common/3dParty/icu/icu.pri
index 424edb381..2b805e847 100644
--- core/Common/3dParty/icu/icu.pri
+++ core/Common/3dParty/icu/icu.pri
@@ -1,5 +1,12 @@
 ICU_MAJOR_VER = 58
 
+core_freebsd {
+    INCLUDEPATH += /usr/local/include
+
+    LIBS        += -licuuc
+    LIBS        += -licudata
+}
+
 core_windows {
     exists($$PWD/$$CORE_BUILDS_PLATFORM_PREFIX/icu) {
         INCLUDEPATH += $$PWD/$$CORE_BUILDS_PLATFORM_PREFIX/icu/include
diff --git a/Common/3dParty/v8/v8.pri b/Common/3dParty/v8/v8.pri
index a59f0b569..822371cb0 100644
--- core/Common/3dParty/v8/v8.pri
+++ core/Common/3dParty/v8/v8.pri
@@ -5,6 +5,11 @@ INCLUDEPATH += \
     $$CORE_V8_PATH_INCLUDE \
     $$CORE_V8_PATH_INCLUDE/include
 
+core_freebsd {
+    LIBS += -lv8_libplatform -lv8_libbase
+    LIBS += -licui18n -licuuc
+}
+
 core_windows {
     CORE_V8_PATH_LIBS = $$CORE_V8_PATH_INCLUDE/out.gn/$$CORE_BUILDS_PLATFORM_PREFIX/$$CORE_BUILDS_CONFIGURATION_PREFIX/obj
 
diff --git a/Common/3dParty/v8/v8_xp/v8.pri b/Common/3dParty/v8/v8_xp/v8.pri
index dc4536a4a..d286ac136 100644
--- core/Common/3dParty/v8/v8_xp/v8.pri
+++ core/Common/3dParty/v8/v8_xp/v8.pri
@@ -16,6 +16,11 @@ core_windows {
     LIBS += -lShell32
 }
 
+core_freebsd {
+    LIBS += -lv8_libplatform -lv8_libbase
+    LIBS += -licui18n -licuuc
+}
+
 core_linux {
     LIBS += -L$$CORE_V8_PATH_LIBS -lv8_base -lv8_libplatform -lv8_libbase -lv8_nosnapshot -lv8_external_snapshot
     LIBS += -L$$CORE_V8_PATH_LIBS -licui18n -licuuc -licudata
diff --git a/Common/DocxFormat/Source/Base/Types_32.h b/Common/DocxFormat/Source/Base/Types_32.h
index 394a8eb9a..11fe4deb3 100644
--- core/Common/DocxFormat/Source/Base/Types_32.h
+++ core/Common/DocxFormat/Source/Base/Types_32.h
@@ -38,7 +38,7 @@
 	typedef unsigned __int16	_UINT16;
 	typedef unsigned __int32	_UINT32;
 	typedef unsigned __int64	_UINT64;
-#elif __linux__
+#elif defined(__FreeBSD__) || defined(__linux__)
         typedef int16_t             _INT16;
         typedef int32_t             _INT32;
         typedef int64_t             _INT64;
diff --git a/Common/DocxFormat/Source/DocxFormat/Docx.cpp b/Common/DocxFormat/Source/DocxFormat/Docx.cpp
index 3609fe3c1..9c0a2b21c 100644
--- core/Common/DocxFormat/Source/DocxFormat/Docx.cpp
+++ core/Common/DocxFormat/Source/DocxFormat/Docx.cpp
@@ -67,7 +67,7 @@ namespace OOX {
 	void CDocx::FixAfterRead()
 	{
 		//solve id conflict between comments and documentComments
-		if(NULL != m_pComments && m_pComments->m_arrComments.size() > 0 && NULL != m_pDocumentComments && NULL != m_pDocumentComments->m_arrComments.size() > 0)
+		if(NULL != m_pComments && m_pComments->m_arrComments.size() > 0 && NULL != m_pDocumentComments && NULL != m_pDocumentComments && m_pDocumentComments->m_arrComments.size() > 0)
 		{
 			int maxId = INT_MIN;
 			for (size_t i = 0; i < m_pComments->m_arrComments.size(); ++i)
diff --git a/Common/DocxFormat/Source/XlsxFormat/Common.cpp b/Common/DocxFormat/Source/XlsxFormat/Common.cpp
index d3b3341ea..5ef3bb417 100644
--- core/Common/DocxFormat/Source/XlsxFormat/Common.cpp
+++ core/Common/DocxFormat/Source/XlsxFormat/Common.cpp
@@ -43,6 +43,10 @@
 #define _gcvt gcvt
 #endif
 
+#ifdef __FreeBSD__
+#define _gcvt(x,n,b) sprintf(b, "%.17g", x)
+#endif
+
 #define DBL_MAX 15
 #define DBL_MAXDIG10 17
 
diff --git a/Common/base.pri b/Common/base.pri
index e07c164c7..c2ad08e31 100644
--- core/Common/base.pri
+++ core/Common/base.pri
@@ -76,6 +76,14 @@ android {
     DEFINES += __ANDROID__ LINUX _LINUX
 }
 
+freebsd-clang {
+    message("freebsd-clang")
+    CONFIG += core_freebsd
+    CONFIG += core_freebsd_64
+    QMAKE_CC = ccache clang10
+    QMAKE_CXX = ccache clang++10
+}
+
 win32:contains(QMAKE_TARGET.arch, x86_64): {
     CONFIG += core_win_64
 }
diff --git a/Common/kernel.pro b/Common/kernel.pro
index 9b26c55ff..715b3e175 100644
--- core/Common/kernel.pro
+++ core/Common/kernel.pro
@@ -32,6 +32,12 @@ HEADERS += \
 
 SOURCES += ./FileDownloader/FileDownloader.cpp
 
+core_freebsd{
+    SOURCES += \
+        ./FileDownloader/FileDownloader_curl.cpp
+
+    LIBS += -lcurl
+}
 core_windows {
     SOURCES += \
         ./FileDownloader/FileDownloader_win.cpp
diff --git a/DesktopEditor/AllFontsGen/AllFontsGen.pro b/DesktopEditor/AllFontsGen/AllFontsGen.pro
index 245103df8..d2f4e3ca5 100644
--- core/DesktopEditor/AllFontsGen/AllFontsGen.pro
+++ core/DesktopEditor/AllFontsGen/AllFontsGen.pro
@@ -17,6 +17,12 @@ DEFINES += KERNEL_USE_DYNAMIC_LIBRARY
 DEFINES += GRAPHICS_USE_DYNAMIC_LIBRARY
 ADD_DEPENDENCY(graphics, kernel, UnicodeConverter)
 
+core_freebsd {
+    LIBS += -lz -pthread
+
+    QMAKE_LFLAGS += -Wl,--rpath=./
+}
+
 core_windows {
     DEFINES += \
     JAS_WIN_MSVC_BUILD \
diff --git a/DesktopEditor/Qt_build/graphics/project/graphics.pri b/DesktopEditor/Qt_build/graphics/project/graphics.pri
index 83000305a..3c57bfeda 100644
--- core/DesktopEditor/Qt_build/graphics/project/graphics.pri
+++ core/DesktopEditor/Qt_build/graphics/project/graphics.pri
@@ -9,6 +9,12 @@ DEFINES += \
     MNG_STORE_CHUNKS\
     MNG_ERROR_TELLTALE
 
+core_freebsd {
+    DEFINES += \
+    HAVE_UNISTD_H
+    QMAKE_CXXFLAGS += -Wno-narrowing
+}
+
 core_linux {
     DEFINES += \
     HAVE_UNISTD_H
diff --git a/DesktopEditor/Qt_build/graphics/project/graphics_fonts.pri b/DesktopEditor/Qt_build/graphics/project/graphics_fonts.pri
index 49b1b3a17..eb78aa9b4 100644
--- core/DesktopEditor/Qt_build/graphics/project/graphics_fonts.pri
+++ core/DesktopEditor/Qt_build/graphics/project/graphics_fonts.pri
@@ -3,6 +3,11 @@ DEFINES += \
     _QT \
     FT2_BUILD_LIBRARY
 
+core_freebsd {
+    DEFINES += \
+    HAVE_UNISTD_H
+}
+
 core_linux {
     DEFINES += \
     HAVE_UNISTD_H
diff --git a/DesktopEditor/agg-2.4/include/agg_math.h b/DesktopEditor/agg-2.4/include/agg_math.h
index 58d99bfa9..d47c82023 100644
--- core/DesktopEditor/agg-2.4/include/agg_math.h
+++ core/DesktopEditor/agg-2.4/include/agg_math.h
@@ -431,7 +431,7 @@ namespace agg
         }
     }
 
-#if defined(_LINUX) || defined(__APPLE__)
+#if defined(__FreeBSD__) || defined(_LINUX) || defined(__APPLE__)
     inline double _hypot(const double& x, const double& y)
     {
         return sqrt(x * x + y * y);
diff --git a/DesktopEditor/agg-2.4/include/agg_span_gradient.h b/DesktopEditor/agg-2.4/include/agg_span_gradient.h
index 8543a4dcc..9512f2375 100644
--- core/DesktopEditor/agg-2.4/include/agg_span_gradient.h
+++ core/DesktopEditor/agg-2.4/include/agg_span_gradient.h
@@ -24,7 +24,7 @@
 
 namespace agg
 {
-#if !defined(_LINUX) && !(defined(_WIN32) || defined (_WIN64)) && !defined(__APPLE__)
+#if !defined(__FreeBSD__) && !defined(_LINUX) && !(defined(_WIN32) || defined (_WIN64)) && !defined(__APPLE__)
     double _hypot(double x, double y)
     {
         return sqrt(x*x + y*y);
diff --git a/DesktopEditor/allthemesgen/allthemesgen.pro b/DesktopEditor/allthemesgen/allthemesgen.pro
index 664144457..b69ff3327 100644
--- core/DesktopEditor/allthemesgen/allthemesgen.pro
+++ core/DesktopEditor/allthemesgen/allthemesgen.pro
@@ -17,6 +17,12 @@ DEFINES += KERNEL_USE_DYNAMIC_LIBRARY
 DEFINES += GRAPHICS_USE_DYNAMIC_LIBRARY
 ADD_DEPENDENCY(graphics, kernel, UnicodeConverter, doctrenderer)
 
+core_freebsd {
+    LIBS += -lz -pthread
+
+    QMAKE_LFLAGS += -Wl,--rpath=./
+}
+
 core_windows {
     DEFINES -= UNICODE
     DEFINES -= _UNICODE
diff --git a/DesktopEditor/common/Directory.cpp b/DesktopEditor/common/Directory.cpp
index 0f9d33fd7..fda0256c9 100644
--- core/DesktopEditor/common/Directory.cpp
+++ core/DesktopEditor/common/Directory.cpp
@@ -35,7 +35,7 @@
     #include "windef.h"
     #include <shlobj.h>
     #include <Rpc.h>
-#elif __linux__
+#elif defined(__FreeBSD__) || defined(__linux__)
     #include <sys/types.h>
     #include <sys/stat.h>
     #include <unistd.h>
@@ -120,7 +120,7 @@ namespace NSDirectory
         FindClose( hRes );
 #endif
 
-#ifdef __linux__
+#if defined(__FreeBSD__) || defined(__linux__)
         BYTE* pUtf8 = NULL;
         LONG lLen = 0;
         NSFile::CUtf8Converter::GetUtf8StringFromUnicode(strDirectory.c_str(), strDirectory.length(), pUtf8, lLen, false);
@@ -233,7 +233,7 @@ namespace NSDirectory
 			}
 		} while( FindNextFileW( hRes, &oFD ) );		
 		FindClose( hRes );
-#elif __linux__
+#elif defined(__FreeBSD__) || defined(__linux__)
 		BYTE* pUtf8 = NULL;
 		LONG lLen = 0;
         NSFile::CUtf8Converter::GetUtf8StringFromUnicode(strDirectory.c_str(), strDirectory.length(), pUtf8, lLen, false);
@@ -297,7 +297,7 @@ namespace NSDirectory
 #if defined(_WIN32) || defined (_WIN64)
 		DWORD dwAttrib = ::GetFileAttributesW(strDirectory.c_str());
 		return (dwAttrib != INVALID_FILE_ATTRIBUTES && 0 != (dwAttrib & FILE_ATTRIBUTE_DIRECTORY));
-#elif __linux__
+#elif defined(__FreeBSD__) || defined(__linux__)
         BYTE* pUtf8 = NULL;
         LONG lLen = 0;
         NSFile::CUtf8Converter::GetUtf8StringFromUnicode(strDirectory.c_str(), strDirectory.length(), pUtf8, lLen, false);
@@ -396,7 +396,7 @@ namespace NSDirectory
         return true;
 #endif
 
-#ifdef __linux__
+#if defined(__FreeBSD__) || defined(__linux__)
         BYTE* pUtf8 = NULL;
         LONG lLen = 0;
         NSFile::CUtf8Converter::GetUtf8StringFromUnicode(strSrc.c_str(), strSrc.length(), pUtf8, lLen, false);
@@ -491,7 +491,7 @@ namespace NSDirectory
 		}
 #if defined(_WIN32) || defined (_WIN64)
 		if (deleteRoot) RemoveDirectoryW(strDirectory.c_str());
-#elif __linux__
+#elif defined(__FreeBSD__) ||  defined(__linux__)
 		BYTE* pUtf8 = NULL;
 		LONG lLen = 0;
         NSFile::CUtf8Converter::GetUtf8StringFromUnicode(strDirectory.c_str(), strDirectory.length(), pUtf8, lLen, false);
diff --git a/DesktopEditor/common/File.cpp b/DesktopEditor/common/File.cpp
index 71d173408..f826b0c48 100644
--- core/DesktopEditor/common/File.cpp
+++ core/DesktopEditor/common/File.cpp
@@ -39,9 +39,13 @@
     #include <windows.h>
 #endif
 
-#if defined(__linux__) || defined(_MAC) && !defined(_IOS)
+#if defined(__FreeBSD__) || defined(__linux__) || defined(_MAC) && !defined(_IOS)
 #include <unistd.h>
 #include <string.h>
+#if defined(__FreeBSD__)
+#include <sys/types.h>
+#include <sys/sysctl.h>
+#endif
 #endif
 
 #ifdef _IOS
@@ -1461,7 +1465,7 @@ namespace NSFile
         return std::wstring(buf);
 #endif
 
-#if defined(__linux__) || defined(_MAC) && !defined(_IOS)
+#if defined(__FreeBSD__) || defined(__linux__) || defined(_MAC) && !defined(_IOS)
         char buf[NS_FILE_MAX_PATH];
         memset(buf, 0, NS_FILE_MAX_PATH);
         if (readlink ("/proc/self/exe", buf, NS_FILE_MAX_PATH) <= 0)
@@ -1472,6 +1476,21 @@ namespace NSFile
             std::string sUTF8(buf);
             std::wstring sRet = CUtf8Converter::GetUnicodeStringFromUTF8((BYTE*)sUTF8.c_str(), sUTF8.length());
             return sRet;
+#endif
+#if defined(__FreeBSD__)
+        int mib[4] = {CTL_KERN, KERN_PROC, KERN_PROC_PATHNAME, -1};
+        char buf[NS_FILE_MAX_PATH];
+        size_t size = NS_FILE_MAX_PATH;
+
+        memset(buf, 0, NS_FILE_MAX_PATH);
+        if (sysctl(mib, 4, &buf, &size, NULL, 0) != 0) {
+            size = readlink("/proc/curproc/file", buf, size - 1);
+            if (size < 0)
+            return L"";
+        }
+        std::string sUTF8(buf);
+        std::wstring sRet = CUtf8Converter::GetUnicodeStringFromUTF8((BYTE*)sUTF8.c_str(), sUTF8.length());
+        return sRet;
 #endif
             return L"";
         }
diff --git a/DesktopEditor/common/Path.cpp b/DesktopEditor/common/Path.cpp
index 4508dc2a0..4ce8fb45e 100644
--- core/DesktopEditor/common/Path.cpp
+++ core/DesktopEditor/common/Path.cpp
@@ -34,7 +34,7 @@
 
 #if defined(_WIN32) || defined (_WIN64)
     #include <tchar.h>
-#elif __linux__ || MAC
+#elif __FreeBSD__ || __linux__ || MAC
     #include <libgen.h>
 #endif
 
@@ -53,7 +53,7 @@ namespace NSSystemPath
 		sRes.append(tFolder);
 		if(sRes.length() > 0)
 			sRes.erase(sRes.length()-1);
-#elif __linux__ || MAC
+#elif __FreeBSD__ || __linux__ || MAC
 		BYTE* pUtf8 = NULL;
 		LONG lLen = 0;
 		NSFile::CUtf8Converter::GetUtf8StringFromUnicode(strFileName.c_str(), strFileName.length(), pUtf8, lLen, false);
@@ -73,7 +73,7 @@ namespace NSSystemPath
 		sRes.append(tFilename);
 		sRes.append(tExt);
 		return sRes;
-#elif __linux__ || MAC
+#elif __FreeBSD__ || __linux__ || MAC
 		BYTE* pUtf8 = NULL;
 		LONG lLen = 0;
 		NSFile::CUtf8Converter::GetUtf8StringFromUnicode(strFileName.c_str(), strFileName.length(), pUtf8, lLen, false);
diff --git a/DesktopEditor/common/Types.h b/DesktopEditor/common/Types.h
index d63f2ff25..907880ac2 100644
--- core/DesktopEditor/common/Types.h
+++ core/DesktopEditor/common/Types.h
@@ -75,7 +75,7 @@ typedef int				INT;
 typedef unsigned int	UINT, *PUINT;
 typedef wchar_t			WCHAR;
 
-#ifdef __linux__
+#if defined(__FreeBSD__) || defined(__linux__)
 #include <inttypes.h>
 typedef int64_t     T_LONG64;
 typedef uint64_t    T_ULONG64;
diff --git a/DesktopEditor/cximage/CxImage/ximage.h b/DesktopEditor/cximage/CxImage/ximage.h
index 61f8f4aa5..dc66f1982 100644
--- core/DesktopEditor/cximage/CxImage/ximage.h
+++ core/DesktopEditor/cximage/CxImage/ximage.h
@@ -52,7 +52,7 @@
 #pragma once
 #endif 
 
-#ifdef _LINUX
+#if defined(__FreeBSD__) || defined(_LINUX)
   #define _XOPEN_SOURCE
   #include <unistd.h>
   #include <arpa/inet.h>
diff --git a/DesktopEditor/cximage/CxImage/ximainfo.cpp b/DesktopEditor/cximage/CxImage/ximainfo.cpp
index e3a278c0c..0bdc6ffab 100644
--- core/DesktopEditor/cximage/CxImage/ximainfo.cpp
+++ core/DesktopEditor/cximage/CxImage/ximainfo.cpp
@@ -5,7 +5,7 @@
 
 #include "ximage.h"
 
-#if defined(_LINUX) || defined(__APPLE__)
+#if defined(__FreeBSD__) || defined(_LINUX) || defined(__APPLE__)
     #ifdef UNICODE
         #define _tcsnicmp(a,b,c) wcscasecmp(a,b)
     #else
diff --git a/DesktopEditor/cximage/CxImage/ximajas.h b/DesktopEditor/cximage/CxImage/ximajas.h
index 24781ee4d..988dc49d2 100644
--- core/DesktopEditor/cximage/CxImage/ximajas.h
+++ core/DesktopEditor/cximage/CxImage/ximajas.h
@@ -16,7 +16,7 @@
 
 #if CXIMAGE_SUPPORT_JASPER
 
-#ifdef _LINUX
+#if defined(__FreeBSD__) || defined(_LINUX)
  #include <jasper/jasper.h>
 #else
  #include "../jasper/include/jasper/jasper.h"
diff --git a/DesktopEditor/cximage/CxImage/ximajpg.cpp b/DesktopEditor/cximage/CxImage/ximajpg.cpp
index 686dc1807..7e3430217 100644
--- core/DesktopEditor/cximage/CxImage/ximajpg.cpp
+++ core/DesktopEditor/cximage/CxImage/ximajpg.cpp
@@ -9,7 +9,7 @@
 
 #if CXIMAGE_SUPPORT_JPG
 
-#ifdef _LINUX
+#if defined(__FreeBSD__) || defined(_LINUX)
  #include <jmorecfg.h>
 #else
  #include "../jpeg/jmorecfg.h"
diff --git a/DesktopEditor/cximage/CxImage/ximajpg.h b/DesktopEditor/cximage/CxImage/ximajpg.h
index 4cb2484a8..5f2f2e8ba 100644
--- core/DesktopEditor/cximage/CxImage/ximajpg.h
+++ core/DesktopEditor/cximage/CxImage/ximajpg.h
@@ -29,7 +29,7 @@
 #define CXIMAGEJPG_SUPPORT_EXIF CXIMAGE_SUPPORT_EXIF
 
 extern "C" {
-#ifdef _LINUX
+#if defined(__FreeBSD__) || defined(_LINUX)
  #include <jpeglib.h>
  #include <jerror.h>
 #else
diff --git a/DesktopEditor/cximage/CxImage/ximapng.h b/DesktopEditor/cximage/CxImage/ximapng.h
index cf9c4a5d5..5652a7885 100644
--- core/DesktopEditor/cximage/CxImage/ximapng.h
+++ core/DesktopEditor/cximage/CxImage/ximapng.h
@@ -22,7 +22,7 @@
 #if CXIMAGE_SUPPORT_PNG
 
 extern "C" {
-#ifdef _LINUX
+#if defined(__FreeBSD__) || defined(_LINUX)
  #undef _DLL
  #include <png.h>
  #include <pngstruct.h>
diff --git a/DesktopEditor/cximage/CxImage/ximaraw.cpp b/DesktopEditor/cximage/CxImage/ximaraw.cpp
index af6dd0def..eabc95702 100644
--- core/DesktopEditor/cximage/CxImage/ximaraw.cpp
+++ core/DesktopEditor/cximage/CxImage/ximaraw.cpp
@@ -204,7 +204,7 @@ bool CxImageRAW::Decode(CxFile *hFile)
 				for (c=0; c < dcr.colors; c++) ppm2[col*dcr.colors+c] = dcr.image[soff][c];
 		}
 		if (dcr.opt.output_bps == 16 && !dcr.opt.output_tiff && htons(0x55aa) != 0x55aa)
-#if defined(_LINUX) || defined(__APPLE__)
+#if defined(__FreeBSD__) || defined(_LINUX) || defined(__APPLE__)
 			swab ((char*)ppm2, (char*)ppm2, dcr.width*dcr.colors*2);
 #else
 			_swab ((char*)ppm2, (char*)ppm2, dcr.width*dcr.colors*2);
diff --git a/DesktopEditor/cximage/raw/libdcr.h b/DesktopEditor/cximage/raw/libdcr.h
index 212c15a2e..78bd9be56 100644
--- core/DesktopEditor/cximage/raw/libdcr.h
+++ core/DesktopEditor/cximage/raw/libdcr.h
@@ -42,7 +42,7 @@
  #include <sys/types.h>
 #endif
 
-#if defined(_LINUX) || defined(__APPLE__)
+#if defined(__FreeBSD__) || defined(_LINUX) || defined(__APPLE__)
  #include <setjmp.h>
  #include <sys/types.h>
  #define _swab   swab
diff --git a/DesktopEditor/cximage/tiff/tif_config.h b/DesktopEditor/cximage/tiff/tif_config.h
index 76e55df81..c3769c5ef 100644
--- core/DesktopEditor/cximage/tiff/tif_config.h
+++ core/DesktopEditor/cximage/tiff/tif_config.h
@@ -19,7 +19,7 @@
 #define HAVE_SYS_TYPES_H 1
 
 /* Define to 1 if you have the <io.h> header file. */
-#ifndef _LINUX
+#if !defined(__FreeBSD__) && !defined(_LINUX)
 #define HAVE_IO_H 1
 #endif
 
@@ -35,7 +35,7 @@
 /* The size of a `long', as computed by sizeof. */
 #define SIZEOF_LONG 4
 
-#ifndef _LINUX
+#if !defined(__FreeBSD__) && !defined(_LINUX)
 /* Signed 64-bit type */
 #define TIFF_INT64_T signed __int64
 
@@ -43,7 +43,7 @@
 #define TIFF_UINT64_T unsigned __int64
 #endif
 
-#ifdef _LINUX
+#if  defined(__FreeBSD__) || defined(_LINUX)
 #include <inttypes.h>
 
 /* Signed 64-bit type */
@@ -69,7 +69,7 @@
 //# endif
 //#endif
 
-#ifndef _LINUX
+#if !defined(__FreeBSD__) && !defined(_LINUX)
 #define lfind _lfind
 #endif
 /*
diff --git a/DesktopEditor/cximage/tiff/tiffconf.h b/DesktopEditor/cximage/tiff/tiffconf.h
index be746e6ea..3d5fb817c 100644
--- core/DesktopEditor/cximage/tiff/tiffconf.h
+++ core/DesktopEditor/cximage/tiff/tiffconf.h
@@ -25,7 +25,7 @@
 /* Signed 64-bit type formatter */
 #define TIFF_INT64_FORMAT "%lld"
 
-#ifndef _LINUX
+#if defined(__FreeBSD__) || defined(_LINUX)
 /* Signed 64-bit type */
 #define TIFF_INT64_T signed __int64
 
@@ -33,7 +33,7 @@
 #define TIFF_UINT64_T unsigned __int64
 #endif
 
-#ifdef _LINUX
+#if defined(__FreeBSD__) || defined(_LINUX)
 #include <inttypes.h>
 
 /* Signed 64-bit type */
diff --git a/DesktopEditor/graphics/pro/graphics.pro b/DesktopEditor/graphics/pro/graphics.pro
index efe07df2d..77d3b6df1 100644
--- core/DesktopEditor/graphics/pro/graphics.pro
+++ core/DesktopEditor/graphics/pro/graphics.pro
@@ -34,6 +34,12 @@ DEFINES += \
 
 DEFINES += FT_SUPPORT_UTF8_IN_NAMES
 
+core_freebsd {
+    DEFINES += \
+    HAVE_UNISTD_H
+    QMAKE_CXXFLAGS += -Wno-narrowing
+}
+
 core_linux {
     DEFINES += \
     HAVE_UNISTD_H
diff --git a/DesktopEditor/graphics/pro/raster.pri b/DesktopEditor/graphics/pro/raster.pri
index c43a71134..fa1f7fcca 100644
--- core/DesktopEditor/graphics/pro/raster.pri
+++ core/DesktopEditor/graphics/pro/raster.pri
@@ -11,6 +11,12 @@ DEFINES += \
     MNG_STORE_CHUNKS\
     MNG_ERROR_TELLTALE
 
+core_freebsd {
+    DEFINES += \
+    HAVE_UNISTD_H
+    QMAKE_CXXFLAGS += -Wno-narrowing
+}
+
 core_linux {
     DEFINES += \
     HAVE_UNISTD_H
diff --git a/DesktopEditor/raster/JBig2/source/LeptonLib/readfile.cpp b/DesktopEditor/raster/JBig2/source/LeptonLib/readfile.cpp
index 2c398d5c6..3a938bd9f 100644
--- core/DesktopEditor/raster/JBig2/source/LeptonLib/readfile.cpp
+++ core/DesktopEditor/raster/JBig2/source/LeptonLib/readfile.cpp
@@ -81,10 +81,10 @@ static const char JP2K_IMAGE_DATA[12] = {
 };
 
 #else
-static const char JP2K_CODESTREAM[4] = { 0xff, 0x4f, 0xff, 0x51 };
+static const char JP2K_CODESTREAM[4] = { static_cast<char>(0xff), 0x4f, static_cast<char>(0xff), 0x51 };
 static const char JP2K_IMAGE_DATA[12] = { 0x00, 0x00, 0x00, 0x0C,
     0x6A, 0x50, 0x20, 0x20,
-    0x0D, 0x0A, 0x87, 0x0A };
+    0x0D, 0x0A, static_cast<char>(0x87), 0x0A };
 #endif
 
 /*---------------------------------------------------------------------*
diff --git a/DesktopEditor/xmlsec/libxmlsec.pro b/DesktopEditor/xmlsec/libxmlsec.pro
index 7bc34983a..102f67a77 100644
--- core/DesktopEditor/xmlsec/libxmlsec.pro
+++ core/DesktopEditor/xmlsec/libxmlsec.pro
@@ -45,6 +45,16 @@ DEFINES += \
     IN_XMLSEC \
     XMLSEC_STATIC
 
+core_freebsd {
+    #CONFIG += use_gcrypt
+    #CONFIG += use_gnutls
+    #CONFIG += use_mscrypto
+    #CONFIG += use_nss
+    CONFIG += use_openssl
+    #CONFIG += use_skeleton
+    #CONFIG += use_xslt
+}
+
 core_linux {
     #CONFIG += use_gcrypt
     #CONFIG += use_gnutls
diff --git a/DesktopEditor/xmlsec/src/ooxmlsignature.pro b/DesktopEditor/xmlsec/src/ooxmlsignature.pro
index 0afe6454c..a9a00fed9 100644
--- core/DesktopEditor/xmlsec/src/ooxmlsignature.pro
+++ core/DesktopEditor/xmlsec/src/ooxmlsignature.pro
@@ -20,6 +20,10 @@ ADD_DEPENDENCY(kernel)
 
 DEFINES -= UNICODE
 
+core_freebsd {
+    CONFIG += signature_openssl
+}
+
 core_linux {
     CONFIG += signature_openssl
 }
diff --git a/DesktopEditor/xmlsec/test/OpenSSL_gui_test/OpenSSL_gui_test.pro b/DesktopEditor/xmlsec/test/OpenSSL_gui_test/OpenSSL_gui_test.pro
index caad5a190..ef4a21b10 100644
--- core/DesktopEditor/xmlsec/test/OpenSSL_gui_test/OpenSSL_gui_test.pro
+++ core/DesktopEditor/xmlsec/test/OpenSSL_gui_test/OpenSSL_gui_test.pro
@@ -19,6 +19,10 @@ CORE_ROOT_DIR = $$PWD/../../../..
 PWD_ROOT_DIR = $$PWD
 include($$CORE_ROOT_DIR/Common/base.pri)
 
+core_freebsd {
+    QMAKE_LFLAGS += -Wl,--rpath=./
+}
+
 core_linux {
     QMAKE_LFLAGS += -Wl,--rpath=./
     QMAKE_LFLAGS += -static-libstdc++ -static-libgcc
diff --git a/DjVuFile/DjVuFile.pro b/DjVuFile/DjVuFile.pro
index 1d718869a..211cc6359 100644
--- core/DjVuFile/DjVuFile.pro
+++ core/DjVuFile/DjVuFile.pro
@@ -21,6 +21,17 @@ DEFINES -= \
     UNICODE \
     _UNICODE
 
+core_freebsd {
+    DEFINES += \
+    HAVE_UNISTD_H \
+    HAVE_MBSTATE_T \
+    GCONTAINER_NO_MEMBER_TEMPLATES="1" \
+    HAS_WCHAR \
+    HAVE_WCHAR_H \
+    UNIX \
+    HAVE_STDINCLUDES
+}
+
 core_linux {
     DEFINES += \
     HAVE_UNISTD_H \
diff --git a/DjVuFile/libdjvu/DjVuDocument.cpp b/DjVuFile/libdjvu/DjVuDocument.cpp
index 020d8f229..9d8ef05f0 100644
--- core/DjVuFile/libdjvu/DjVuDocument.cpp
+++ core/DjVuFile/libdjvu/DjVuDocument.cpp
@@ -78,7 +78,7 @@
 
 #include "debug.h"
 
-#if defined(__linux__) || defined(LINUX)
+#if defined(__FreeBSD__) || defined(__linux__) || defined(LINUX)
 typedef unsigned int	UINT;
 #endif
 
diff --git a/HtmlFile/HtmlFile.cpp b/HtmlFile/HtmlFile.cpp
index d110e9a24..7912280f1 100644
--- core/HtmlFile/HtmlFile.cpp
+++ core/HtmlFile/HtmlFile.cpp
@@ -45,7 +45,7 @@
 #include <vector>
 #include <map>
 
-#ifdef LINUX
+#if defined(__FreeBSD__) || defined(LINUX)
 #include <unistd.h>
 #include <sys/wait.h>
 #include <stdio.h>
@@ -408,7 +408,7 @@ int CHtmlFile::Convert(const std::vector<std::wstring>& arFiles, const std::wstr
     NSFile::CFileBinary::Remove(sTempFileForParams);
 #endif
 
-#ifdef LINUX
+#if defined(__FreeBSD__) || defined(LINUX)
     std::wstring sTempFileForParams = NSFile::CFileBinary::CreateTempFileWithUniqueName(NSFile::CFileBinary::GetTempPath(), L"XML");
     NSFile::CFileBinary oFile;
     oFile.CreateFileW(sTempFileForParams);
diff --git a/HtmlFile/HtmlFile.pro b/HtmlFile/HtmlFile.pro
index 6434fa5e0..b1bb61377 100644
--- core/HtmlFile/HtmlFile.pro
+++ core/HtmlFile/HtmlFile.pro
@@ -18,6 +18,10 @@ include(../Common/base.pri)
 
 ADD_DEPENDENCY(kernel, UnicodeConverter)
 
+core_freebsd {
+    DEFINES += asc_static_link_libstd
+}
+
 core_linux {
     DEFINES += asc_static_link_libstd
 }
diff --git a/Makefile b/Makefile
index cbcf30b56..9a69ce213 100644
--- core/Makefile
+++ core/Makefile
@@ -10,6 +10,10 @@ ifeq ($(UNAME_M),x86_64)
 	ARCHITECTURE := 64
 	ARCH_SUFFIX := x64
 endif
+ifeq ($(UNAME_M),amd64)
+       ARCHITECTURE := 64
+       ARCH_SUFFIX := x64
+endif
 ifneq ($(filter %86,$(UNAME_M)),)
 	ARCHITECTURE := 32
 	ARCH_SUFFIX := x86
@@ -40,6 +44,18 @@ else
 		PACKAGE_VERSION := $(PRODUCT_VERSION)-$(BUILD_NUMBER)
 		ARCH_REPO_DIR := linux
 	endif
+        ifeq ($(UNAME_S),FreeBSD)
+                PLATFORM := freebsd
+                SHARED_EXT := .so*
+                SHELL_EXT := .sh
+                LIB_EXT := .a
+                LIB_PREFIX := lib
+                ARCH_EXT := .tar.gz
+                MAKE := gmake
+                AR := tar -zcvf
+                PACKAGE_VERSION := $(PRODUCT_VERSION)-$(BUILD_NUMBER)
+                ARCH_REPO_DIR := freebsd
+        endif
 	ifeq ($(UNAME_S),Darwin)
 		PLATFORM := mac
 		SHARED_EXT := .dylib
diff --git a/OfficeUtils/OfficeUtils.pri b/OfficeUtils/OfficeUtils.pri
index 9b0ae446a..9ad733e55 100644
--- core/OfficeUtils/OfficeUtils.pri
+++ core/OfficeUtils/OfficeUtils.pri
@@ -1,6 +1,11 @@
+core_freebsd {
+    QMAKE_CXXFLAGS += -Wall -Wno-ignored-qualifiers
+}
+
 core_linux {
     QMAKE_CXXFLAGS += -Wall -Wno-ignored-qualifiers
 }
+
 core_mac {
     QMAKE_CXXFLAGS += -Wall -Wno-ignored-qualifiers
     DEFINES += unix
diff --git a/PdfWriter/PdfWriter.pro b/PdfWriter/PdfWriter.pro
index 6cf8c6067..6d4d235ac 100644
--- core/PdfWriter/PdfWriter.pro
+++ core/PdfWriter/PdfWriter.pro
@@ -22,6 +22,10 @@ LIBS += -L$$CORE_BUILDS_LIBRARIES_PATH -lCryptoPPLib
 
 DEFINES += NOMINMAX
 
+core_freebsd {
+    QMAKE_CXXFLAGS += -Wno-narrowing
+}
+
 core_linux {
     QMAKE_CXXFLAGS += -Wno-narrowing
 }
diff --git a/UnicodeConverter/UnicodeConverter.pro b/UnicodeConverter/UnicodeConverter.pro
index 45adf72c3..7c10127f3 100644
--- core/UnicodeConverter/UnicodeConverter.pro
+++ core/UnicodeConverter/UnicodeConverter.pro
@@ -15,6 +15,10 @@ include(../Common/base.pri)
 
 DEFINES += UNICODECONVERTER_USE_DYNAMIC_LIBRARY
 
+core_freebsd {
+    QMAKE_LFLAGS += -Wl,--rpath=./
+}
+
 core_linux {
     QMAKE_LFLAGS += -Wl,--rpath=./
 }
diff --git a/UnicodeConverter/icubuilds-mac/icu/unicode/platform.h b/UnicodeConverter/icubuilds-mac/icu/unicode/platform.h
index 471caa233..11ac450b7 100644
--- core/UnicodeConverter/icubuilds-mac/icu/unicode/platform.h
+++ core/UnicodeConverter/icubuilds-mac/icu/unicode/platform.h
@@ -150,7 +150,7 @@
 #   include <android/api-level.h>
 #elif defined(__native_client__)
 #   define U_PLATFORM U_PF_BROWSER_NATIVE_CLIENT
-#elif defined(linux) || defined(__linux__) || defined(__linux)
+#elif defined(__FreeBSD__) || defined(linux) || defined(__linux__) || defined(__linux)
 #   define U_PLATFORM U_PF_LINUX
 #elif defined(__APPLE__) && defined(__MACH__)
 #   include <TargetConditionals.h>
diff --git a/X2tConverter/build/Qt/X2tConverter.pri b/X2tConverter/build/Qt/X2tConverter.pri
index 76e204a04..3fde067e6 100755
--- core/X2tConverter/build/Qt/X2tConverter.pri
+++ core/X2tConverter/build/Qt/X2tConverter.pri
@@ -100,6 +100,10 @@ ADD_DEPENDENCY(graphics, kernel, UnicodeConverter, PdfWriter, PdfReader, HtmlFil
 CONFIG += core_boost_regex
 include($$PWD/../../../Common/3dParty/boost/boost.pri)
 
+core_freebsd {
+    LIBS += -liconv
+}
+
 core_windows {
     LIBS += -lAdvapi32
 }
diff --git a/X2tConverter/src/ASCConverters.cpp b/X2tConverter/src/ASCConverters.cpp
index 6823da87f..2bacd15a9 100644
--- core/X2tConverter/src/ASCConverters.cpp
+++ core/X2tConverter/src/ASCConverters.cpp
@@ -3948,7 +3948,7 @@ namespace NExtractTools
 	{
 		bool bMacros = true;
 		
-		_UINT32 nRes = ConvertXls2Xlsx( sFrom, sTo, params.getPassword(), params.getFontPath(), sTemp, NULL, bMacros);
+		_UINT32 nRes = ConvertXls2Xlsx( sFrom, sTo, params.getPassword(), params.getFontPath(), sTemp, 0, bMacros);
 
 		nRes = processEncryptionError(nRes, sFrom, params);
 		return nRes;
@@ -3981,7 +3981,7 @@ namespace NExtractTools
         NSDirectory::CreateDirectory(sResultXlsxDir);
 
 		bool bMacros = true;
-		_UINT32 nRes = ConvertXls2Xlsx( sFrom, sResultXlsxDir, params.getPassword(), params.getFontPath(), sTemp, NULL, bMacros);
+		_UINT32 nRes = ConvertXls2Xlsx( sFrom, sResultXlsxDir, params.getPassword(), params.getFontPath(), sTemp, 0, bMacros);
 
 		nRes = processEncryptionError(nRes, sFrom, params);
 		if (SUCCEEDED_X2T(nRes))
-- 
2.27.0

